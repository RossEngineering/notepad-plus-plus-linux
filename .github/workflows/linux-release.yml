name: Linux Release Artifacts

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version/tag (example: v0.7.0). Defaults to manual-<sha>.'
        required: false
        type: string
      publish_release:
        description: 'Publish GitHub Release in addition to uploading workflow artifacts'
        required: false
        default: false
        type: boolean
      prerelease:
        description: 'Mark GitHub release as prerelease'
        required: false
        default: false
        type: boolean

concurrency:
  group: linux-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      LINUX_RELEASE_GPG_KEY: ${{ secrets.LINUX_RELEASE_GPG_KEY }}
      LINUX_RELEASE_GPG_PASSPHRASE: ${{ secrets.LINUX_RELEASE_GPG_PASSPHRASE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            g++ \
            pkg-config \
            rpm \
            qt6-base-dev \
            qt6-5compat-dev \
            zstd

      - name: Resolve release metadata
        id: release_meta
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF_NAME}"
            PUBLISH="true"
            if [[ "${GITHUB_REF_NAME}" == *-* ]]; then
              PRERELEASE="true"
              MAKE_LATEST="false"
            else
              PRERELEASE="false"
              MAKE_LATEST="true"
            fi
            TAG_NAME="${GITHUB_REF_NAME}"
          else
            RAW_VERSION="${{ inputs.version }}"
            if [[ -z "${RAW_VERSION}" ]]; then
              RAW_VERSION="manual-$(git rev-parse --short HEAD)"
            fi
            VERSION="${RAW_VERSION//\//-}"
            PUBLISH="${{ inputs.publish_release }}"
            PRERELEASE="${{ inputs.prerelease }}"
            if [[ "${PRERELEASE}" == "true" ]]; then
              MAKE_LATEST="false"
            else
              MAKE_LATEST="true"
            fi
            TAG_NAME="${VERSION}"
          fi

          RELEASE_NOTES_FILE=""
          if [[ "${PUBLISH}" == "true" ]]; then
            CANDIDATE_NOTES_FILE="docs/releases/${VERSION}.md"
            if [[ ! -f "${CANDIDATE_NOTES_FILE}" ]]; then
              echo "::error::Expected release notes file not found: ${CANDIDATE_NOTES_FILE}"
              exit 1
            fi
            RELEASE_NOTES_FILE="${CANDIDATE_NOTES_FILE}"
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "publish=${PUBLISH}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"
          echo "make_latest=${MAKE_LATEST}" >> "$GITHUB_OUTPUT"
          echo "tag_name=${TAG_NAME}" >> "$GITHUB_OUTPUT"
          echo "release_notes_file=${RELEASE_NOTES_FILE}" >> "$GITHUB_OUTPUT"
          echo "release_name=Notepad++ Linux ${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build release artifacts
        shell: bash
        run: |
          NPP_RELEASE_NATIVE_PACKAGES=1 \
            ./scripts/release/create_linux_release_artifacts.sh "${{ steps.release_meta.outputs.version }}"

      - name: Import GPG key (optional)
        if: ${{ env.LINUX_RELEASE_GPG_KEY != '' }}
        shell: bash
        run: |
          echo "$LINUX_RELEASE_GPG_KEY" | base64 -d | gpg --batch --import

      - name: Sign artifacts (optional)
        if: ${{ env.LINUX_RELEASE_GPG_KEY != '' }}
        shell: bash
        run: |
          shopt -s nullglob
          for artifact in out/release/*; do
            if [[ "${artifact}" == *.asc ]]; then
              continue
            fi
            gpg --batch --yes --pinentry-mode loopback \
              --passphrase "$LINUX_RELEASE_GPG_PASSPHRASE" \
              --armor --detach-sign "$artifact"
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release-artifacts-${{ steps.release_meta.outputs.version }}
          path: out/release/*
          if-no-files-found: error
          retention-days: 30

      - name: Publish GitHub release
        if: ${{ steps.release_meta.outputs.publish == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag_name }}
          target_commitish: ${{ github.sha }}
          name: ${{ steps.release_meta.outputs.release_name }}
          prerelease: ${{ steps.release_meta.outputs.prerelease }}
          body_path: ${{ steps.release_meta.outputs.release_notes_file }}
          make_latest: ${{ steps.release_meta.outputs.make_latest }}
          fail_on_unmatched_files: true
          files: out/release/*
