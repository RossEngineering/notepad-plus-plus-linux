name: Linux Release Artifacts

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build release artifacts
        shell: bash
        run: |
          RAW_VERSION="${GITHUB_REF_NAME:-manual-$(git rev-parse --short HEAD)}"
          VERSION="${RAW_VERSION//\//-}"
          ./scripts/release/create_linux_release_artifacts.sh "$VERSION"

      - name: Import GPG key (optional)
        if: ${{ secrets.LINUX_RELEASE_GPG_KEY != '' }}
        shell: bash
        env:
          LINUX_RELEASE_GPG_KEY: ${{ secrets.LINUX_RELEASE_GPG_KEY }}
        run: |
          echo "$LINUX_RELEASE_GPG_KEY" | base64 -d | gpg --batch --import

      - name: Sign artifacts (optional)
        if: ${{ secrets.LINUX_RELEASE_GPG_KEY != '' }}
        shell: bash
        env:
          GPG_PASSPHRASE: ${{ secrets.LINUX_RELEASE_GPG_PASSPHRASE }}
        run: |
          shopt -s nullglob
          for artifact in out/release/*.tar.xz out/release/*.sha256; do
            gpg --batch --yes --pinentry-mode loopback \
              --passphrase "$GPG_PASSPHRASE" \
              --armor --detach-sign "$artifact"
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release-artifacts
          path: out/release/*
          if-no-files-found: error

      - name: Publish GitHub release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: out/release/*
